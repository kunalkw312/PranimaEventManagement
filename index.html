<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pranima Management</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#000000">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    /* --- MINIMALIST BLACK & WHITE THEME --- */
    body { font-family: 'Inter', sans-serif; background-color: #ffffff; color: #000; padding-bottom: 80px; }
    
    /* Typography */
    .brand-font { font-family: 'Playfair Display', serif; letter-spacing: 0.5px; }
    h5, label { color: #000; font-weight: 600; }
    
    /* Layout */
    .main-container { max-width: 850px; margin: 20px auto; padding: 20px; }

    /* Forms */
    .form-control, .form-select { 
      border: 1px solid #000; /* Black borders */
      border-radius: 0; /* Sharp corners for clean look */
      padding: 10px; 
      color: #000;
    }
    .form-control:focus, .form-select:focus { 
      box-shadow: none; 
      border-color: #000; 
      background-color: #f9f9f9;
    }

    /* Tabs */
    .nav-pills .nav-link { color: #666; font-weight: 600; border-radius: 0; }
    .nav-pills .nav-link.active { background-color: #000; color: #fff; }

    /* Buttons */
    .btn { border-radius: 0; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; font-size: 0.85rem; }
    .btn-dark { background-color: #000; border: 1px solid #000; }
    .btn-outline-dark { border: 1px solid #000; color: #000; }
    .btn-outline-dark:hover { background-color: #000; color: #fff; }

    /* --- EVENT BLOCKS (The Fix) --- */
    .event-block { 
      border-top: 2px solid #000; 
      margin-bottom: 30px; 
      padding-top: 20px; 
      position: relative; 
    }
    
    /* Colored Icons as requested */
    .btn-delete-event {
      position: absolute;
      top: -15px;
      right: 0;
      background: #fff;
      color: #dc3545; /* RED */
      border: 1px solid #dc3545;
      padding: 5px 10px;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .btn-delete-event:hover { background: #dc3545; color: #fff; }

    .equipment-row { 
      display: flex; 
      align-items: center; 
      gap: 10px; 
      margin-bottom: 10px; 
    }
    .btn-remove-item {
      color: #dc3545; /* RED */
      border: 1px solid #eee;
      background: #fff;
      width: 40px; height: 40px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      font-size: 1.2rem;
    }
    .btn-remove-item:hover { background: #ffeeee; }

    /* History */
    .history-item { border-bottom: 1px solid #eee; padding: 15px 0; }
    .history-item:last-child { border-bottom: none; }

    /* Payment Box */
    .payment-summary { background: #f4f4f4; padding: 20px; margin-top: 20px; border: 1px solid #000; }

    /* UI Utilities */
    #installBtn { display: none; }
    #toast-overlay { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; }
    .custom-toast { background: #000; color: #fff; padding: 10px 20px; margin-bottom: 10px; display: none; }
    .custom-toast.show { display: block; animation: fadeIn 0.3s; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* --- PRINT STYLES --- */
    #printable-area { display: none; }
    @media print {
      @page { size: A4; margin: 0.5cm; }
      body, html { background: #fff; margin: 0; padding: 0; width: 100%; }
      .main-container, .nav, .btn, #toast-overlay, #installContainer { display: none !important; }
      
      #printable-area { 
        display: block !important; 
        position: absolute; top: 0; left: 0; width: 100%; 
        font-family: 'Inter', sans-serif; font-size: 11px; color: #000; 
      }
      
      .print-header { display: flex; justify-content: space-between; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px; }
      .print-logo { width: 90px; }
      .print-title { font-family: 'Playfair Display'; font-weight: 700; font-size: 1.8rem; text-transform: uppercase; }
      
      .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
      .print-table th { border-bottom: 1px solid #000; text-align: left; padding: 4px; font-size: 0.85rem; background: #eee; -webkit-print-color-adjust: exact; }
      .print-table td { border-bottom: 1px solid #eee; padding: 4px; }
      
      .totals-section { display: flex; justify-content: flex-end; margin-top: 10px; }
      .totals-table { width: 250px; text-align: right; }
      .grand-total { border-top: 2px solid #000; font-weight: 700; font-size: 1.1rem; padding-top: 5px; }
      
      .disclaimer { margin-top: 25px; font-size: 0.7rem; color: #555; text-align: justify; border-top: 1px solid #ccc; padding-top: 10px; }
      .print-footer { text-align: center; margin-top: 10px; font-weight: 600; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

  <div id="toast-overlay"><div id="toast-msg" class="custom-toast">Action Successful</div></div>

  <div class="main-container">
    <div class="text-center mb-4">
      <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" alt="Logo" style="height: 80px; margin-bottom: 10px;">
      <h3 class="brand-font m-0">Pranima Event Management</h3>
      <div id="installContainer" class="mt-3"><button id="installBtn" class="btn btn-outline-dark btn-sm">Install App</button></div>
    </div>

    <ul class="nav nav-pills nav-fill mb-4">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-generator">INVOICE</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history" onclick="fetchHistory()">HISTORY</button></li>
    </ul>

    <div class="tab-content">
      
      <div class="tab-pane fade show active" id="tab-generator">
        <form id="mainForm" onsubmit="event.preventDefault(); saveRecord();">
          
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label>Customer Name</label>
              <input type="text" class="form-control" id="custName" required>
            </div>
            <div class="col-md-6">
              <label>Phone Number</label>
              <input type="tel" class="form-control" id="custPhone" required>
            </div>
          </div>

          <div class="row g-3 mb-4">
             <div class="col-6">
               <label>Type</label>
               <select class="form-select" id="docType"><option value="Estimate">Estimate</option><option value="Invoice">Invoice</option></select>
             </div>
             <div class="col-6">
               <label>Date</label>
               <input type="date" class="form-control" id="docDate" required>
             </div>
          </div>

          <div id="events-container"></div>
          
          <button type="button" class="btn btn-outline-dark w-100 py-2 mb-4" onclick="addEventBlock()">
             + ADD ANOTHER EVENT
          </button>

          <div class="payment-summary">
             <div class="d-flex justify-content-between mb-2">
                <span>Total Amount:</span>
                <span class="fw-bold fs-5">₹<span id="displayTotal">0.00</span></span>
             </div>
             <div class="d-flex justify-content-between align-items-center mb-2">
                <span>Advance Paid:</span>
                <input type="number" id="advanceAmt" class="form-control text-end" style="width: 120px; border: 1px solid #999;" placeholder="0" oninput="calculateTotal()">
             </div>
             <div class="d-flex justify-content-between pt-2 border-top border-dark">
                <span class="fw-bold">Balance Due:</span>
                <span class="fw-bold fs-5 text-danger">₹<span id="displayRemaining">0.00</span></span>
             </div>
          </div>

          <div class="d-flex gap-2 mt-4">
             <button type="button" class="btn btn-outline-dark flex-grow-1" onclick="generatePreview(true)">PREVIEW</button>
             <button type="submit" class="btn btn-dark flex-grow-1"><span id="saveBtnText">SAVE & PRINT</span></button>
          </div>
        </form>
      </div>

      <div class="tab-pane fade" id="tab-history">
        <div class="d-flex mb-4">
           <input type="text" id="searchInput" class="form-control" placeholder="Search invoices..." onkeyup="filterHistory()">
           <button class="btn btn-dark ms-2" onclick="fetchHistory()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div id="historyList">
           <div class="text-center py-5 text-muted">Tap refresh to load history</div>
        </div>
      </div>
    </div>
  </div>

  <div id="printable-area"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // PASTE YOUR WEB APP URL HERE
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzimQLhnbiV0IDut5yz6s9xlDY_jBl0X0e-yYQTAZE4LDpreE9y1ywLqOuCdKO-IXB9/exec"; 
    // ==========================================

    let historyCache = [];
    document.getElementById('docDate').valueAsDate = new Date();
    addEventBlock();

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error)); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-block'; });
    document.getElementById('installBtn').addEventListener('click', () => { document.getElementById('installBtn').style.display = 'none'; if(deferredPrompt) deferredPrompt.prompt(); });

    async function callApi(payload) {
      const formBody = new URLSearchParams();
      formBody.append("payload", JSON.stringify(payload));
      const response = await fetch(API_URL, { method: "POST", body: formBody, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
      return await response.json();
    }

    // Calculations
    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.equipment-row').forEach(row => {
         const qty = parseFloat(row.querySelector('.qty-input').value) || 1;
         const price = parseFloat(row.querySelector('.price-input').value) || 0;
         total += (qty * price);
      });
      const adv = parseFloat(document.getElementById('advanceAmt').value) || 0;
      const rem = total - adv;
      document.getElementById('displayTotal').innerText = total.toLocaleString('en-IN', {minimumFractionDigits:2});
      document.getElementById('displayRemaining').innerText = rem.toLocaleString('en-IN', {minimumFractionDigits:2});
      return { total, adv, rem };
    }

    // Builder Functions
    function addEventBlock() {
      const id = Date.now();
      const div = document.createElement('div');
      div.className = 'event-block';
      div.id = `evt-${id}`;
      div.innerHTML = `
        <button type="button" class="btn-delete-event" onclick="removeEl('evt-${id}')" title="Delete Event"><i class="bi bi-trash-fill"></i></button>
        <div class="row g-2 mb-3">
           <div class="col-8">
             <label class="small text-muted">Event Name</label>
             <input type="text" class="form-control fw-bold event-name" placeholder="e.g. Wedding" required>
           </div>
           <div class="col-4">
             <label class="small text-muted">Date</label>
             <input type="date" class="form-control event-date" required>
           </div>
        </div>
        <div class="items-list"></div>
        <button type="button" class="btn btn-sm btn-link text-dark text-decoration-none p-0 mt-2" onclick="addItemRow(this)">+ ADD ITEM</button>
      `;
      document.getElementById('events-container').appendChild(div);
      addItemRow(div.querySelector('.btn-link')); // Auto add one item
    }

    function addItemRow(btn) {
      const list = btn.previousElementSibling;
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      div.className = 'equipment-row';
      div.id = `item-${id}`;
      div.innerHTML = `
        <div style="flex: 2"><input type="text" class="form-control item-name" placeholder="Item Name"></div>
        <div style="width: 70px"><input type="number" class="form-control qty-input text-center" value="1" oninput="calculateTotal()"></div>
        <div style="width: 100px"><input type="number" class="form-control price-input text-end" placeholder="₹" oninput="calculateTotal()"></div>
        <div class="btn-remove-item" onclick="removeEl('item-${id}')"><i class="bi bi-x-lg"></i></div>
      `;
      list.appendChild(div);
    }
    function removeEl(id) { document.getElementById(id).remove(); calculateTotal(); }

    function getFormData() {
      const nums = calculateTotal();
      const data = {
        customerName: document.getElementById('custName').value,
        customerPhone: document.getElementById('custPhone').value,
        type: document.getElementById('docType').value,
        issueDate: document.getElementById('docDate').value,
        grandTotal: nums.total.toLocaleString('en-IN', {minimumFractionDigits:2}),
        advance: nums.adv,
        remaining: nums.rem,
        events: []
      };
      document.querySelectorAll('.event-block').forEach(blk => {
        const evt = { eventName: blk.querySelector('.event-name').value, eventDate: blk.querySelector('.event-date').value, items: [] };
        blk.querySelectorAll('.equipment-row').forEach(row => {
            evt.items.push({ 
                name: row.querySelector('.item-name').value, 
                qty: row.querySelector('.qty-input').value, 
                price: row.querySelector('.price-input').value 
            });
        });
        data.events.push(evt);
      });
      return data;
    }

    // Save
    async function saveRecord() {
      const form = document.getElementById('mainForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      const btn = document.getElementById('saveBtnText');
      btn.innerText = "SAVING...";
      try {
        const data = getFormData();
        const res = await callApi({ action: 'SAVE', data: data });
        btn.innerText = "SAVE & PRINT";
        if (res.success) { showToast("Saved Successfully"); data.invoiceId = res.id; printInvoice(data); }
        else { showToast("Error Saving"); }
      } catch (err) { btn.innerText = "SAVE & PRINT"; showToast("Connection Error"); }
    }

    // History Logic
    async function fetchHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '<div class="text-center py-5 text-muted">Loading records...</div>';
      try {
        const data = await callApi({ action: 'GET_HISTORY' });
        historyCache = data;
        renderHistory(data);
      } catch (err) { list.innerHTML = `<div class="text-center text-danger">Failed to load</div>`; }
    }

    function renderHistory(data) {
       const list = document.getElementById('historyList');
       list.innerHTML = '';
       if (!data || data.length === 0) { list.innerHTML = '<div class="text-center text-muted">No records found.</div>'; return; }
       
       data.forEach(row => {
          let rec = { advance: row.advance || 0, remaining: row.remaining || row.total, grandTotal: row.total };
          try { if(row.jsonData) rec = JSON.parse(row.jsonData); } catch(e){}
          if(row.advance !== undefined) { rec.advance = row.advance; rec.remaining = row.remaining; }

          const div = document.createElement('div');
          div.className = 'history-item';
          div.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
               <div>
                  <div class="fw-bold fs-5">${row.name}</div>
                  <div class="small text-muted">${row.id} • ${new Date(row.date).toLocaleDateString('en-IN')}</div>
               </div>
               <div class="text-end">
                  <div class="fw-bold">₹${rec.grandTotal}</div>
                  <div class="small ${rec.remaining > 0 ? 'text-danger' : 'text-success'}">Bal: ₹${rec.remaining}</div>
               </div>
            </div>
            <div class="d-flex justify-content-end gap-2 mt-2">
               <button class="btn btn-sm btn-outline-dark" onclick='updatePayment("${row.id}")'>UPDATE PAY</button>
               <button class="btn btn-sm btn-outline-dark" onclick='reprintHistory("${row.id}")'><i class="bi bi-printer"></i></button>
               <button class="btn btn-sm btn-outline-danger" onclick='deleteHistory("${row.id}")'><i class="bi bi-trash"></i></button>
            </div>
          `;
          list.appendChild(div);
       });
    }

    async function updatePayment(id) {
       const newAdv = prompt("Enter NEW TOTAL Advance Amount:");
       if(newAdv === null) return;
       showToast("Updating...");
       try {
         const res = await callApi({ action: 'UPDATE_PAYMENT', id: id, advance: newAdv });
         if(res.success) { showToast("Updated"); fetchHistory(); } else { showToast("Error"); }
       } catch(e) { showToast("Failed"); }
    }

    async function deleteHistory(id) {
       if(!confirm("Permanently delete " + id + "?")) return;
       showToast("Deleting...");
       try { const res = await callApi({ action: 'DELETE', id: id }); if(res.success){ showToast("Deleted"); fetchHistory();} } catch(e){}
    }
    
    function reprintHistory(id) { const record = historyCache.find(r => r.id === id); if (record) { const data = JSON.parse(record.jsonData); data.invoiceId = id; printInvoice(data); } }
    function filterHistory() { const term = document.getElementById('searchInput').value.toLowerCase(); const items = document.querySelectorAll('.history-item'); items.forEach(c => c.style.display = c.innerText.toLowerCase().includes(term) ? '' : 'none'); }
    function showToast(msg) { const t=document.getElementById('toast-msg'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    function generatePreview() { const data = getFormData(); data.invoiceId = "PREVIEW"; printInvoice(data); }

    function printInvoice(data) {
      const area = document.getElementById('printable-area');
      const totalStr = String(data.grandTotal).replace(/,/g,'');
      const total = parseFloat(totalStr);
      const adv = parseFloat(data.advance) || 0;
      const rem = parseFloat(data.remaining) || (total - adv);

      let html = `
        <div class="print-header">
           <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" class="print-logo">
           <div class="text-end">
              <div class="print-title">${data.type}</div>
              <div class="print-meta">ID: ${data.invoiceId}<br>Date: ${data.issueDate}</div>
           </div>
        </div>
        <div class="print-customer"><strong>Bill To:</strong><br>${data.customerName}<br>${data.customerPhone}</div>
      `;

      data.events.forEach(evt => {
        html += `
          <div style="margin-bottom:15px; page-break-inside:avoid;">
             <strong>${evt.eventName}</strong> <span style="color:#666; font-size:0.9em">(${evt.eventDate})</span>
             <table class="print-table">
               <thead><tr><th width="50%">Item</th><th width="15%" class="text-center">Qty</th><th width="20%" class="text-end">Rate</th><th width="15%" class="text-end">Amt</th></tr></thead>
               <tbody>
        `;
        evt.items.forEach(item => {
           const qty = parseFloat(item.qty);
           const rate = parseFloat(item.price);
           const amt = qty * rate;
           html += `<tr><td>${item.name}</td><td class="text-center">${qty}</td><td class="text-end">${rate}</td><td class="text-end">${amt.toLocaleString('en-IN')}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      });

      html += `
        <div class="totals-section">
           <table class="totals-table">
              <tr><td>Total Amount:</td><td style="font-weight:600">₹${total.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
              <tr><td>Advance Paid:</td><td>₹${adv.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
              <tr><td class="grand-total">Balance Due:</td><td class="grand-total">₹${rem.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
           </table>
        </div>
        <div class="disclaimer">
           <strong>Disclaimer:</strong> While Pranima Event Management strives for perfection, we are not liable for service interruptions caused by technical failures, power outages, weather conditions, or equipment malfunctions beyond our direct control. Any refunds or adjustments related to such issues will be at the sole discretion of management.
        </div>
        <div class="print-footer">Thank you for choosing Pranima Event Management!</div>
      `;
      area.innerHTML = html;
      setTimeout(() => window.print(), 500);
    }
  </script>
</body>
</html>

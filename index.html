<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pranima Management</title>
  
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    /* --- THEME --- */
    :root { --primary: #111; --secondary: #666; --bg-color: #f8f9fa; --card-bg: #ffffff; --border: #eee; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary); padding-bottom: 60px; }
    
    h1, h2, h3, h4 { font-weight: 700; color: var(--primary); }
    .brand-font { font-family: 'Playfair Display', serif; letter-spacing: 1px; }
    
    .main-container { 
      max-width: 950px; 
      margin: 40px auto; 
      background: var(--card-bg); 
      border-radius: 16px; 
      box-shadow: 0 10px 40px rgba(0,0,0,0.04); 
      padding: 40px; 
    }

    /* Buttons & Inputs */
    .btn-dark { background-color: #111; border-color: #111; }
    .btn-outline-dark { color: #111; border-color: #ddd; }
    .btn-outline-dark:hover { background-color: #111; border-color: #111; color: #fff; }
    
    .form-control, .form-select { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }

    /* --- EVENT BLOCKS --- */
    .event-block { 
      background: #fafafa; 
      border: 1px solid #eee; 
      border-radius: 12px; 
      padding: 25px; 
      margin-bottom: 25px; 
      position: relative; 
      padding-top: 50px; 
    }
    .delete-event-btn { 
      position: absolute; top: 15px; right: 15px; 
      color: #dc3545; border: 1px solid #eee; background: #fff; 
      width: 35px; height: 35px; border-radius: 50%; 
      display: flex; align-items: center; justify-content: center; 
      transition: 0.2s; cursor: pointer;
    }
    .delete-event-btn:hover { background: #dc3545; color: white; border-color: #dc3545; }

    /* Equipment Rows */
    .equipment-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    .equipment-row:last-child { border-bottom: none; }
    .btn-remove-item { border: none; background: transparent; color: #dc3545; opacity: 0.6; }
    .btn-remove-item:hover { opacity: 1; }

    /* --- CLEAN HISTORY CARDS (No Black Bar) --- */
    .history-card {
       background: #fff;
       border: 1px solid #eee; /* Clean border all around */
       padding: 20px;
       margin-bottom: 15px;
       border-radius: 12px;
       box-shadow: 0 2px 8px rgba(0,0,0,0.02);
       transition: transform 0.2s;
    }
    .history-card:active { transform: scale(0.99); }
    
    .badge-pill { padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; letter-spacing: 0.5px; }
    .badge-paid { background: #f0fdf4; color: #166534; border: 1px solid #dcfce7; }
    .badge-due { background: #fef2f2; color: #991b1b; border: 1px solid #fee2e2; }

    /* --- TOAST (TOP POSITION) --- */
    #toast-overlay { 
      position: fixed; 
      top: 20px; /* Moved to Top */
      left: 50%; 
      transform: translateX(-50%); 
      z-index: 9999; 
      pointer-events: none; 
    }
    .custom-toast { 
      background: #111; 
      color: #fff; 
      padding: 12px 24px; 
      border-radius: 50px; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
      opacity: 0; 
      transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
      transform: translateY(-20px); /* Starts slightly above */
      font-weight: 500;
      display: flex; align-items: center; gap: 10px;
    }
    .custom-toast.show { opacity: 1; transform: translateY(0); }
    .custom-toast.error { background: #dc3545; }

    /* --- MODAL STYLING --- */
    .modal-content { border-radius: 16px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    .modal-header { border-bottom: 1px solid #eee; padding: 20px; }
    .modal-footer { border-top: none; padding: 20px; }
    
    #installBtn { display: none; }
    #printable-area { display: none; }
    
    @media print {
      @page { size: A4; margin: 0.8cm; }
      body, html { height: 100%; width: 100%; margin: 0; background-color: white; }
      .main-container, .nav, .btn, #toast-overlay, #installContainer, .modal-backdrop, .modal { display: none !important; }
      
      #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; font-family: 'Inter', sans-serif; font-size: 12px; color: #000; }
      
      .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #000; padding-bottom: 15px; }
      .print-logo { width: 100px; height: auto; }
      .print-title { font-size: 2rem; font-family: 'Playfair Display'; font-weight: 700; text-transform: uppercase; margin: 0; }
      .print-meta { text-align: right; font-size: 0.9rem; line-height: 1.4; }
      
      .print-customer { margin-bottom: 25px; background: #f9f9f9; padding: 15px; border-radius: 6px; -webkit-print-color-adjust: exact; }
      
      .event-section { margin-bottom: 20px; page-break-inside: avoid; }
      .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.95rem; }
      .print-table th { text-align: left; border-bottom: 1px solid #000; padding: 5px; font-weight: 700; background: #f0f0f0; -webkit-print-color-adjust: exact; }
      .print-table td { padding: 5px; border-bottom: 1px solid #eee; }
      
      .totals-area { display: flex; justify-content: flex-end; margin-top: 20px; }
      .totals-table { width: 300px; text-align: right; font-size: 1rem; }
      .totals-table td { padding: 4px 0; }
      .row-grand { border-top: 2px solid #000; font-weight: 700; font-size: 1.2rem; padding-top: 8px; margin-top: 5px; }
      
      .disclaimer { margin-top: 40px; border-top: 1px solid #ccc; padding-top: 10px; font-size: 0.75rem; color: #555; text-align: justify; }
      .print-footer { margin-top: 20px; text-align: center; font-size: 0.8rem; font-weight: 600; color: #333; }
    }
  </style>
</head>
<body>

  <div id="toast-overlay">
    <div id="toast-msg" class="custom-toast">
       <span id="toast-icon"></span>
       <span id="toast-text">Notification</span>
    </div>
  </div>

  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Update Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <label class="form-label text-muted small fw-bold">ENTER NEW TOTAL ADVANCE PAID</label>
          <div class="input-group">
            <span class="input-group-text bg-light border-end-0">₹</span>
            <input type="number" id="modalPaymentInput" class="form-control border-start-0 ps-0" placeholder="0.00">
          </div>
          <div class="form-text mt-2">This will recalculate the remaining balance automatically.</div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark rounded-pill px-4" onclick="confirmUpdatePayment()">Save Update</button>
        </div>
      </div>
    </div>
  </div>

  <div class="main-container">
    <div class="text-center mb-5">
      <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" alt="Logo" style="height: 100px; margin-bottom: 15px;">
      <h2 class="brand-font">Pranima Event Management</h2>
      <p class="text-muted">Invoice & Estimate Generator</p>
      <div id="installContainer" class="mt-2"><button id="installBtn" class="btn btn-sm btn-outline-dark rounded-pill"><i class="bi bi-download me-1"></i> Install App</button></div>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 gap-2">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-generator">New Invoice</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history" onclick="fetchHistory()">History</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-generator">
        <form id="mainForm" onsubmit="event.preventDefault(); saveRecord();">
          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold">Customer</label>
              <input type="text" class="form-control mb-2" id="custName" placeholder="Full Name" required>
              <input type="tel" class="form-control" id="custPhone" placeholder="Mobile Number" required>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold">Document</label>
              <div class="d-flex gap-2 mb-2">
                <select class="form-select" id="docType"><option value="Estimate">Estimate</option><option value="Invoice">Invoice</option></select>
                <input type="date" class="form-control" id="docDate" required>
              </div>
            </div>
          </div>

          <div id="events-container"></div>
          
          <button type="button" class="btn btn-outline-dark w-100 py-3 mb-4" style="border-style: dashed;" onclick="addEventBlock()">
             <i class="bi bi-plus-circle me-1"></i> Add Another Event
          </button>

          <div class="bg-light p-4 rounded-3 mb-4 border">
             <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Total Amount</span>
                <span class="fw-bold fs-5">₹<span id="displayTotal">0.00</span></span>
             </div>
             <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Advance Payment</span>
                <input type="number" id="advanceAmt" class="form-control text-end" style="width: 140px;" placeholder="0" oninput="calculateTotal()">
             </div>
             <div class="d-flex justify-content-between pt-3 border-top">
                <span class="fw-bold">Remaining Balance</span>
                <span class="fw-bold fs-4 text-danger">₹<span id="displayRemaining">0.00</span></span>
             </div>
          </div>

          <div class="d-flex justify-content-end gap-3">
             <button type="button" class="btn btn-lg btn-outline-dark" onclick="generatePreview(true)">Print Preview</button>
             <button type="submit" class="btn btn-lg btn-dark px-5"><span id="saveBtnText">Save & Print</span><span id="saveSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span></button>
          </div>
        </form>
      </div>

      <div class="tab-pane fade" id="tab-history">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <input type="text" id="searchInput" class="form-control w-75" placeholder="Search..." onkeyup="filterHistory()">
          <button class="btn btn-outline-secondary" onclick="fetchHistory()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div id="historyList">
           <div class="text-center py-5 text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div id="printable-area"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // PASTE YOUR WEB APP URL HERE
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzimQLhnbiV0IDut5yz6s9xlDY_jBl0X0e-yYQTAZE4LDpreE9y1ywLqOuCdKO-IXB9/exec"; 
    // ==========================================

    let historyCache = [];
    let currentUpdateId = null; // Store ID for modal
    const paymentModal = new bootstrap.Modal(document.getElementById('paymentModal'));

    document.getElementById('docDate').valueAsDate = new Date();
    addEventBlock();

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error)); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-block'; });
    document.getElementById('installBtn').addEventListener('click', () => { document.getElementById('installBtn').style.display = 'none'; if(deferredPrompt) deferredPrompt.prompt(); });

    async function callApi(payload) {
      const formBody = new URLSearchParams();
      formBody.append("payload", JSON.stringify(payload));
      const response = await fetch(API_URL, { method: "POST", body: formBody, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
      return await response.json();
    }

    // Calculations
    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.equipment-row').forEach(row => {
         const qty = parseFloat(row.querySelector('.qty-input').value) || 1;
         const price = parseFloat(row.querySelector('.price-input').value) || 0;
         total += (qty * price);
      });
      const adv = parseFloat(document.getElementById('advanceAmt').value) || 0;
      const rem = total - adv;
      document.getElementById('displayTotal').innerText = total.toLocaleString('en-IN', {minimumFractionDigits:2});
      document.getElementById('displayRemaining').innerText = rem.toLocaleString('en-IN', {minimumFractionDigits:2});
      return { total, adv, rem };
    }

    // Builder Functions
    function addEventBlock() {
      const id = Date.now();
      const div = document.createElement('div');
      div.className = 'event-block';
      div.id = `evt-${id}`;
      div.innerHTML = `
        <button type="button" class="delete-event-btn" onclick="removeEl('evt-${id}')"><i class="bi bi-trash"></i></button>
        <div class="row g-3 mb-3">
           <div class="col-md-8"><label class="form-label text-muted small">Event Name</label><input type="text" class="form-control fw-bold event-name" placeholder="e.g. Wedding" required></div>
           <div class="col-md-4"><label class="form-label text-muted small">Date</label><input type="date" class="form-control event-date" required></div>
        </div>
        <div class="items-list"></div>
        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0 mt-3" onclick="addItemRow(this)">+ Add Item/Service</button>
      `;
      document.getElementById('events-container').appendChild(div);
      addItemRow(div.querySelector('.btn-link'));
    }

    function addItemRow(btn) {
      const list = btn.previousElementSibling;
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      div.className = 'equipment-row';
      div.id = `item-${id}`;
      div.innerHTML = `
        <div style="flex: 2"><input type="text" class="form-control item-name" placeholder="Item Name" required></div>
        <div style="width: 80px"><input type="number" class="form-control qty-input text-center" value="1" placeholder="Qty" oninput="calculateTotal()"></div>
        <div style="width: 120px"><input type="number" class="form-control price-input text-end" placeholder="Price" oninput="calculateTotal()"></div>
        <button type="button" class="btn-remove-item" onclick="removeEl('item-${id}')"><i class="bi bi-x-lg"></i></button>
      `;
      list.appendChild(div);
    }
    function removeEl(id) { document.getElementById(id).remove(); calculateTotal(); }

    function getFormData() {
      const nums = calculateTotal();
      const data = {
        customerName: document.getElementById('custName').value,
        customerPhone: document.getElementById('custPhone').value,
        type: document.getElementById('docType').value,
        issueDate: document.getElementById('docDate').value,
        grandTotal: nums.total.toLocaleString('en-IN', {minimumFractionDigits:2}),
        advance: nums.adv,
        remaining: nums.rem,
        events: []
      };
      document.querySelectorAll('.event-block').forEach(blk => {
        const evt = { eventName: blk.querySelector('.event-name').value, eventDate: blk.querySelector('.event-date').value, items: [] };
        blk.querySelectorAll('.equipment-row').forEach(row => {
            evt.items.push({ 
                name: row.querySelector('.item-name').value, 
                qty: row.querySelector('.qty-input').value, 
                price: row.querySelector('.price-input').value 
            });
        });
        data.events.push(evt);
      });
      return data;
    }

    // Save
    async function saveRecord() {
      const form = document.getElementById('mainForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      const btn = document.getElementById('saveBtnText');
      const spinner = document.getElementById('saveSpinner');
      btn.innerText = "Saving..."; spinner.classList.remove('d-none');
      try {
        const data = getFormData();
        const res = await callApi({ action: 'SAVE', data: data });
        btn.innerText = "Save & Print"; spinner.classList.add('d-none');
        if (res.success) { showToast("Saved Successfully"); data.invoiceId = res.id; printInvoice(data); }
        else { showToast("Error Saving", "error"); }
      } catch (err) { btn.innerText = "Save & Print"; spinner.classList.add('d-none'); showToast("Connection Error", "error"); }
    }

    // History Logic
    async function fetchHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '<div class="text-center py-5 text-muted">Loading...</div>';
      try {
        const data = await callApi({ action: 'GET_HISTORY' });
        historyCache = data;
        renderHistory(data);
      } catch (err) { list.innerHTML = `<div class="text-center text-danger">Failed to load</div>`; }
    }

    function renderHistory(data) {
       const list = document.getElementById('historyList');
       list.innerHTML = '';
       if (!data || data.length === 0) { list.innerHTML = '<div class="text-center text-muted">No records found.</div>'; return; }
       
       data.forEach(row => {
          let rec = { advance: row.advance || 0, remaining: row.remaining || row.total, grandTotal: row.total };
          try { if(row.jsonData) rec = JSON.parse(row.jsonData); } catch(e){}
          if(row.advance !== undefined) { rec.advance = row.advance; rec.remaining = row.remaining; }

          const div = document.createElement('div');
          div.className = 'history-card';
          div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
               <span class="text-muted small">${new Date(row.date).toLocaleDateString('en-IN')}</span>
               <span class="fw-bold">${row.id}</span>
            </div>
            <h5 class="mb-2">${row.name}</h5>
            <div class="d-flex gap-2 mb-3">
               <span class="badge-pill badge-paid">Paid: ₹${rec.advance}</span>
               <span class="badge-pill badge-due">Bal: ₹${rec.remaining}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
               <span class="fw-bold fs-5">₹${rec.grandTotal}</span>
               <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-dark" onclick='openUpdateModal("${row.id}")'>Update Pay</button>
                  <button class="btn btn-sm btn-outline-dark" onclick='reprintHistory("${row.id}")'><i class="bi bi-printer"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick='deleteHistory("${row.id}")'><i class="bi bi-trash"></i></button>
               </div>
            </div>
          `;
          list.appendChild(div);
       });
    }

    // --- NEW MODAL LOGIC ---
    function openUpdateModal(id) {
      currentUpdateId = id;
      document.getElementById('modalPaymentInput').value = ''; // Clear previous
      paymentModal.show();
    }

    async function confirmUpdatePayment() {
       const newAdv = document.getElementById('modalPaymentInput').value;
       if(!newAdv) return;
       
       paymentModal.hide();
       showToast("Updating...");
       
       try {
         const res = await callApi({ action: 'UPDATE_PAYMENT', id: currentUpdateId, advance: newAdv });
         if(res.success) { showToast("Payment Updated"); fetchHistory(); } 
         else { showToast("Error", "error"); }
       } catch(e) { showToast("Failed", "error"); }
    }

    async function deleteHistory(id) {
       if(!confirm("Delete " + id + "?")) return;
       showToast("Deleting...");
       try { const res = await callApi({ action: 'DELETE', id: id }); if(res.success){ showToast("Deleted"); fetchHistory();} } catch(e){}
    }
    
    function reprintHistory(id) { const record = historyCache.find(r => r.id === id); if (record) { const data = JSON.parse(record.jsonData); data.invoiceId = id; printInvoice(data); } }
    function filterHistory() { const term = document.getElementById('searchInput').value.toLowerCase(); const cards = document.querySelectorAll('.history-card'); cards.forEach(c => c.style.display = c.innerText.toLowerCase().includes(term) ? '' : 'none'); }
    
    // Updated Toast Function (Slide from Top)
    function showToast(msg, type='success') { 
      const t = document.getElementById('toast-msg'); 
      const txt = document.getElementById('toast-text');
      const ico = document.getElementById('toast-icon');
      
      txt.innerText = msg;
      ico.innerHTML = type === 'success' ? '<i class="bi bi-check-circle-fill"></i>' : '<i class="bi bi-exclamation-circle-fill"></i>';
      t.className = `custom-toast ${type} show`; 
      
      setTimeout(() => t.classList.remove('show'), 3000); 
    }

    function generatePreview() { const data = getFormData(); data.invoiceId = "PREVIEW"; printInvoice(data); }

    function printInvoice(data) {
      const area = document.getElementById('printable-area');
      const totalStr = String(data.grandTotal).replace(/,/g,'');
      const total = parseFloat(totalStr);
      const adv = parseFloat(data.advance) || 0;
      const rem = parseFloat(data.remaining) || (total - adv);

      let html = `
        <div class="print-header">
           <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" class="print-logo">
           <div class="text-end">
              <div class="print-title">${data.type}</div>
              <div class="print-meta">ID: ${data.invoiceId}<br>Date: ${data.issueDate}</div>
           </div>
        </div>
        <div class="print-customer"><strong>Bill To:</strong><br>${data.customerName}<br>${data.customerPhone}</div>
      `;

      data.events.forEach(evt => {
        html += `
          <div class="event-section">
             <strong>${evt.eventName}</strong> <span style="color:#555; font-size:0.9em">(${evt.eventDate})</span>
             <table class="print-table">
               <thead><tr><th width="50%">Item</th><th width="15%" class="text-center">Qty</th><th width="20%" class="text-end">Rate</th><th width="15%" class="text-end">Amt</th></tr></thead>
               <tbody>
        `;
        evt.items.forEach(item => {
           const qty = parseFloat(item.qty);
           const rate = parseFloat(item.price);
           const amt = qty * rate;
           html += `<tr><td>${item.name}</td><td class="text-center">${qty}</td><td class="text-end">${rate}</td><td class="text-end">${amt.toLocaleString('en-IN')}</td></tr>`;
        });
        html += `</tbody></table></div>`;
      });

      html += `
        <div class="totals-area">
           <table class="totals-table">
              <tr><td>Total:</td><td>₹${total.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
              <tr><td>Advance:</td><td>₹${adv.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
              <tr><td class="row-grand">Balance:</td><td class="row-grand">₹${rem.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
           </table>
        </div>
        <div class="disclaimer">
           <strong>Disclaimer:</strong> While Pranima Event Management strives for perfection, we are not liable for service interruptions caused by technical failures, power outages, weather conditions, or equipment malfunctions beyond our direct control. Any refunds or adjustments related to such issues will be at the sole discretion of management.
        </div>
        <div class="print-footer">Thank you for choosing Pranima Event Management!</div>
      `;
      area.innerHTML = html;
      setTimeout(() => window.print(), 500);
    }
  </script>
</body>
</html>

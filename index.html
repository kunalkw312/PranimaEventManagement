<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pranima Management</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root { --primary: #111; --secondary: #666; --bg-color: #f4f6f8; --card-bg: #ffffff; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary); padding-bottom: 60px; }
    h1, h2, h3, h4 { font-weight: 700; color: var(--primary); }
    .brand-font { font-family: 'Playfair Display', serif; letter-spacing: 1px; }
    .main-container { max-width: 950px; margin: 40px auto; background: var(--card-bg); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); padding: 40px; }
    .nav-pills .nav-link { color: var(--secondary); border-radius: 8px; font-weight: 500; }
    .nav-pills .nav-link.active { background-color: var(--primary); color: #fff; }
    .form-control, .form-select { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    .event-block { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 25px; margin-bottom: 25px; position: relative; }
    .delete-event-btn { position: absolute; top: 15px; right: 15px; color: #dc3545; border: none; background: none; font-size: 1.2rem; cursor: pointer; }
    .equipment-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    #installBtn { display: none; }
    #toast-overlay { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
    .custom-toast { background: #333; color: #fff; padding: 12px 24px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); display: flex; align-items: center; gap: 10px; opacity: 0; transition: 0.3s; transform: translateY(20px); }
    .custom-toast.show { opacity: 1; transform: translateY(0); }
    .custom-toast.error { background: #dc3545; }
    
    /* PRINT STYLES */
    #printable-area { display: none; }
    @media print {
      @page { size: A4; margin: 0.8cm; }
      body, html { height: 100%; width: 100%; margin: 0; background-color: white; }
      .main-container, .nav, .btn, #toast-overlay, #installContainer { display: none !important; }
      #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; visibility: visible !important; font-family: 'Inter', sans-serif; font-size: 12px; color: #000; }
      .print-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 15px; }
      .print-logo { width: 90px; height: auto; }
      .print-title { font-size: 1.8rem; font-family: 'Playfair Display'; font-weight: 700; text-transform: uppercase; margin: 0; }
      .print-meta { text-align: right; font-size: 0.85rem; line-height: 1.3; }
      .print-customer { margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; background-color: #fcfcfc !important; -webkit-print-color-adjust: exact; }
      .event-section { margin-bottom: 15px; page-break-inside: avoid; }
      .print-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
      .print-table th { text-align: left; border-bottom: 1px solid #000; padding: 4px 0; font-weight: 700; }
      .print-table td { padding: 4px 0; border-bottom: 1px solid #eee; }
      .print-summary { margin-top: 20px; border-top: 2px solid #000; padding-top: 10px; text-align: right; font-size: 1rem; }
      .print-disclaimer { margin-top: 40px; font-size: 0.7rem; color: #555; text-align: justify; border-top: 1px solid #ccc; padding-top: 10px; font-style: italic; }
      .print-footer { margin-top: 20px; text-align: center; font-size: 0.8rem; font-weight: 600; }
    }
  </style>
</head>
<body>
  <div id="toast-overlay"><div id="toast-msg" class="custom-toast"><span id="toast-icon"></span><span id="toast-text"></span></div></div>
  <div class="main-container">
    <div class="text-center mb-5">
      <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" alt="Logo" style="height: 100px; margin-bottom: 15px;">
      <h2 class="brand-font">Pranima Event Management</h2>
      <p class="text-muted">Invoice & Estimate Generator</p>
      <div id="installContainer" class="mt-2"><button id="installBtn" class="btn btn-sm btn-outline-dark rounded-pill"><i class="bi bi-download me-1"></i> Install App</button></div>
    </div>
    <ul class="nav nav-pills nav-fill mb-4 gap-2">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-generator"><i class="bi bi-file-earmark-plus me-2"></i>New Invoice</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-history" onclick="fetchHistory()"><i class="bi bi-clock-history me-2"></i>History</button></li>
    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-generator">
        <form id="mainForm" onsubmit="event.preventDefault(); saveRecord();">
          <div class="row g-4 mb-4">
            <div class="col-md-6"><label class="form-label">Customer Details</label><input type="text" class="form-control mb-2" id="custName" placeholder="Full Name" required><input type="tel" class="form-control" id="custPhone" placeholder="Mobile Number" required></div>
            <div class="col-md-6"><label class="form-label">Document Details</label><div class="d-flex gap-2 mb-2"><select class="form-select" id="docType"><option value="Estimate">Estimate</option><option value="Invoice">Invoice</option></select><input type="date" class="form-control" id="docDate" required></div><div class="text-end text-muted small">ID generated automatically</div></div>
          </div>
          <hr class="text-muted opacity-25 my-4">
          <div id="events-container"></div>
          <button type="button" class="btn btn-outline-dark w-100 py-2 mb-4 dashed-border" onclick="addEventBlock()"><i class="bi bi-plus-circle me-1"></i> Add Another Event</button>
          
          <div class="bg-light p-4 rounded-3">
             <div class="row text-end align-items-center mb-2">
               <div class="col-8 text-muted">Total:</div>
               <div class="col-4"><h5 class="mb-0">₹ <span id="displayTotal">0.00</span></h5></div>
             </div>
             <div class="row text-end align-items-center mb-2">
               <div class="col-8 text-muted">Advance Paid:</div>
               <div class="col-4"><input type="number" id="advanceInput" class="form-control text-end d-inline-block" style="width: 120px;" placeholder="0" oninput="calculateTotal()"></div>
             </div>
             <div class="row text-end align-items-center border-top pt-2">
               <div class="col-8 fw-bold">Remaining Balance:</div>
               <div class="col-4"><h3 class="mb-0 text-dark">₹ <span id="displayRemaining">0.00</span></h3></div>
             </div>
          </div>

          <div class="d-flex justify-content-end gap-3 mt-4">
             <button type="button" class="btn btn-lg btn-secondary" onclick="generatePreview(true)"><i class="bi bi-printer me-2"></i> Print Only</button>
             <button type="submit" class="btn btn-lg btn-dark px-5"><span id="saveBtnText">Save & Print</span><span id="saveSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span></button>
          </div>
        </form>
      </div>
      <div class="tab-pane fade" id="tab-history">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <input type="text" id="searchInput" class="form-control w-50" placeholder="Search..." onkeyup="filterHistory()">
          <button class="btn btn-sm btn-outline-secondary" onclick="fetchHistory()"><i class="bi bi-arrow-clockwise"></i> Refresh</button>
        </div>
        <div class="table-responsive">
          <table class="table align-middle"><thead class="table-light"><tr><th>Date</th><th>Details</th><th>Total</th><th class="text-end">Actions</th></tr></thead><tbody id="historyBody"><tr><td colspan="4" class="text-center py-4">Loading...</td></tr></tbody></table>
        </div>
      </div>
    </div>
  </div>
  <div id="printable-area"></div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // PASTE YOUR NEW GOOGLE WEB APP URL HERE
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzLNi4TXBktx5JtxWHWcy41dS3-unWMSx7UjRDBnjrTqU0K9XXXfVhZuJ4ZZ32vv67L/exec"; 
    // ==========================================

    let historyCache = [];
    document.getElementById('docDate').valueAsDate = new Date();
    addEventBlock();

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').catch(console.error); }); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-block'; });
    document.getElementById('installBtn').addEventListener('click', () => { document.getElementById('installBtn').style.display = 'none'; if(deferredPrompt) deferredPrompt.prompt(); });

    async function callApi(payload) {
      const formBody = new URLSearchParams();
      formBody.append("payload", JSON.stringify(payload));
      const response = await fetch(API_URL, { method: "POST", body: formBody, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
      return await response.json();
    }

    // --- CALCULATIONS (Updated for Quantity) ---
    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.equipment-row').forEach(row => {
         const qty = parseFloat(row.querySelector('.qty-input').value) || 1;
         const price = parseFloat(row.querySelector('.price-input').value) || 0;
         total += (qty * price);
      });
      
      const advance = parseFloat(document.getElementById('advanceInput').value) || 0;
      const remaining = total - advance;

      document.getElementById('displayTotal').innerText = total.toLocaleString('en-IN', { minimumFractionDigits: 2 });
      document.getElementById('displayRemaining').innerText = remaining.toLocaleString('en-IN', { minimumFractionDigits: 2 });
    }

    function addEventBlock() {
      const id = Date.now();
      const div = document.createElement('div');
      div.className = 'event-block';
      div.id = `evt-${id}`;
      div.innerHTML = `<button type="button" class="delete-event-btn" onclick="removeEl('evt-${id}')"><i class="bi bi-trash"></i></button><div class="row g-3 mb-3"><div class="col-md-8"><label class="form-label">Event Name</label><input type="text" class="form-control event-name" required></div><div class="col-md-4"><label class="form-label">Date</label><input type="date" class="form-control event-date" required></div></div><div class="items-list"></div><button type="button" class="btn btn-sm btn-link text-decoration-none mt-2 ps-0" onclick="addItemRow(this)">+ Add Item</button>`;
      document.getElementById('events-container').appendChild(div);
      addItemRow(div.querySelector('.btn-link'));
    }

    // --- NEW ITEM ROW WITH QUANTITY ---
    function addItemRow(btn) {
      const list = btn.previousElementSibling;
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      div.className = 'equipment-row';
      div.id = `item-${id}`;
      div.innerHTML = `
        <div class="flex-grow-1"><input type="text" class="form-control item-name" placeholder="Item Name" required></div>
        <div style="width: 80px;"><input type="number" class="form-control qty-input text-center" placeholder="Qty" value="1" min="1" oninput="calculateTotal()" required></div>
        <div style="width: 120px;"><input type="number" class="form-control price-input text-end" placeholder="Price" oninput="calculateTotal()" required></div>
        <button type="button" class="btn-icon text-danger border-0 bg-transparent" onclick="removeEl('item-${id}')"><i class="bi bi-x-lg"></i></button>
      `;
      list.appendChild(div);
    }
    function removeEl(id) { document.getElementById(id).remove(); calculateTotal(); }

    function getFormData() {
      const data = {
        customerName: document.getElementById('custName').value,
        customerPhone: document.getElementById('custPhone').value,
        type: document.getElementById('docType').value,
        issueDate: document.getElementById('docDate').value,
        grandTotal: document.getElementById('displayTotal').innerText,
        advance: document.getElementById('advanceInput').value || "0",
        remaining: document.getElementById('displayRemaining').innerText,
        events: []
      };
      document.querySelectorAll('.event-block').forEach(blk => {
        const evt = { eventName: blk.querySelector('.event-name').value, eventDate: blk.querySelector('.event-date').value, items: [] };
        blk.querySelectorAll('.equipment-row').forEach(row => { 
            evt.items.push({ 
                name: row.querySelector('.item-name').value, 
                qty: row.querySelector('.qty-input').value,
                price: row.querySelector('.price-input').value 
            }); 
        });
        data.events.push(evt);
      });
      return data;
    }

    async function saveRecord() {
      const form = document.getElementById('mainForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      const btnTxt = document.getElementById('saveBtnText');
      const spinner = document.getElementById('saveSpinner');
      btnTxt.innerText = "Saving..."; spinner.classList.remove('d-none');
      try {
        const data = getFormData();
        const res = await callApi({ action: 'SAVE', data: data });
        btnTxt.innerText = "Save & Print"; spinner.classList.add('d-none');
        if (res.success) { showToast("Saved! ID: " + res.id); data.invoiceId = res.id; printInvoice(data); }
        else { showToast("Error: " + res.error, 'error'); }
      } catch (err) {
        btnTxt.innerText = "Save & Print"; spinner.classList.add('d-none');
        showToast("Connection Failed (" + err.message + ")", 'error');
      }
    }

    async function fetchHistory() {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4">Loading...</td></tr>';
      try { const data = await callApi({ action: 'GET_HISTORY' }); historyCache = data; renderHistory(data); } catch (err) { tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-danger">Connection Failed.</td></tr>`; }
    }
    function renderHistory(data) {
      const tbody = document.getElementById('historyBody');
      tbody.innerHTML = '';
      if (!data || data.length === 0) { tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No history found.</td></tr>'; return; }
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(row.date).toLocaleDateString('en-IN')}</td><td><strong>${row.name}</strong><br><span class="text-muted small">${row.type} | ${row.id}</span></td><td class="fw-bold">₹${row.total}</td><td class="text-end"><button class="btn btn-sm btn-outline-dark me-1" onclick='reprintHistory("${row.id}")'><i class="bi bi-printer"></i></button><button class="btn btn-sm btn-outline-danger" onclick='deleteHistory("${row.id}")'><i class="bi bi-trash"></i></button></td>`;
        tbody.appendChild(tr);
      });
    }
    async function deleteHistory(id) { if(!confirm("Delete " + id + "?")) return; showToast("Deleting...", "default"); try { const res = await callApi({ action: 'DELETE', id: id }); if (res.success) { showToast("Deleted"); fetchHistory(); } else { showToast("Failed", 'error'); } } catch(e) { showToast("Failed", 'error'); } }
    function reprintHistory(id) { const record = historyCache.find(r => r.id === id); if (record) { const data = JSON.parse(record.jsonData); data.invoiceId = id; printInvoice(data); } }
    function filterHistory() { const term = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('#historyBody tr').forEach(row => { row.style.display = row.innerText.toLowerCase().includes(term) ? '' : 'none'; }); }
    function generatePreview() { const data = getFormData(); data.invoiceId = "PREVIEW"; printInvoice(data); }
    function showToast(msg, type='success') { const t=document.getElementById('toast-msg'); document.getElementById('toast-text').innerText=msg; document.getElementById('toast-icon').innerHTML=type==='success'?'<i class="bi bi-check-circle-fill"></i>':'<i class="bi bi-exclamation-circle-fill"></i>'; t.className=`custom-toast ${type} show`; setTimeout(()=>t.classList.remove('show'),3000); }

    // --- PRINT WITH DISCLAIMER ---
    function printInvoice(data) {
      const area = document.getElementById('printable-area');
      let html = `<div class="print-header"><img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" class="print-logo"><div class="text-end"><div class="print-title">${data.type}</div><div class="print-meta">ID: ${data.invoiceId}<br>Date: ${data.issueDate}</div></div></div><div class="print-customer"><strong>Bill To:</strong><br>${data.customerName}<br>${data.customerPhone}</div>`;
      
      data.events.forEach(evt => {
        html += `<div class="event-section"><strong>Event: ${evt.eventName}</strong> <span style="color:#666; font-size:0.9em;">(${evt.eventDate})</span><table class="print-table"><thead><tr><th style="width:50%">Description</th><th style="text-align:center; width:15%">Qty</th><th style="text-align:right; width:20%">Price</th><th style="text-align:right; width:15%">Total</th></tr></thead><tbody>`;
        evt.items.forEach(item => { 
           const qty = parseFloat(item.qty) || 1;
           const price = parseFloat(item.price) || 0;
           const lineTotal = qty * price;
           html += `<tr><td>${item.name}</td><td style="text-align:center;">${qty}</td><td style="text-align:right;">₹${price}</td><td style="text-align:right;">₹${lineTotal.toLocaleString('en-IN', {minimumFractionDigits: 2})}</td></tr>`; 
        });
        html += `</tbody></table></div>`;
      });

      const adv = parseFloat(data.advance) || 0;
      
      html += `
        <div class="print-summary">
           <div>Total Amount: <strong>₹${data.grandTotal}</strong></div>
           <div>Advance Paid: ₹${adv.toLocaleString('en-IN', {minimumFractionDigits: 2})}</div>
           <div style="font-size: 1.2rem; margin-top:5px;">Remaining Balance: <strong>₹${data.remaining}</strong></div>
        </div>
        
        <div class="print-disclaimer">
          <strong>Disclaimer:</strong> While Pranima Event Management strives for perfection, we shall not be held liable for any interruptions, delays, or failures caused by technical malfunctions, power outages, equipment breakdown, or force majeure events beyond our reasonable control. Any refunds or adjustments in such cases will be at the sole discretion of the management.
        </div>

        <div class="print-footer">Thank you for choosing Pranima Event Management!</div>
      `;
      area.innerHTML = html;
      setTimeout(() => window.print(), 500);
    }
  </script>
</body>
</html>

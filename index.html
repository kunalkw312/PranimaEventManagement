<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pranima Management</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111111">
  <link rel="apple-touch-icon" href="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <style>
    /* --- APP THEME --- */
    :root { --primary: #111; --secondary: #666; --bg-color: #f4f6f8; --card-bg: #ffffff; --border-color: #eee; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-color); color: var(--primary); padding-bottom: 60px; }
    h1, h2, h3, h4 { font-weight: 700; color: var(--primary); }
    .brand-font { font-family: 'Playfair Display', serif; letter-spacing: 1px; }
    .main-container { max-width: 950px; margin: 40px auto; background: var(--card-bg); border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.04); padding: 40px; }
    
    .nav-pills .nav-link { color: var(--secondary); border-radius: 8px; font-weight: 500; padding: 12px; }
    .nav-pills .nav-link.active { background-color: var(--primary); color: #fff; }
    .form-control, .form-select { border: 1px solid #ddd; border-radius: 8px; padding: 12px; }
    .form-control:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }

    .event-block { background: #fafafa; border: 1px solid #eee; border-radius: 12px; padding: 25px; margin-bottom: 25px; position: relative; padding-top: 50px; }
    .delete-event-btn { position: absolute; top: 15px; right: 15px; color: #dc3545; border: 1px solid #eee; background: #fff; width: 35px; height: 35px; border-radius: 50%; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
    .delete-event-btn:hover { background: #dc3545; color: white; border-color: #dc3545; }
    .equipment-row { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px dashed #eee; }
    .equipment-row:last-child { border-bottom: none; }
    .btn-remove-item { border: none; background: transparent; color: #dc3545; opacity: 0.6; }
    .btn-remove-item:hover { opacity: 1; }

    .history-card { background: #fff; border: 1px solid #eee; padding: 20px; margin-bottom: 15px; border-radius: 12px; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02); }
    .history-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
    .badge-paid { background: #e6f9ea; color: #15803d; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    .badge-due { background: #fee2e2; color: #b91c1c; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: 600; }
    
    .payment-summary { background: #f8f9fa; padding: 20px; border-radius: 12px; border: 1px solid #eee; }

    #installBtn { display: none; }
    #toast-overlay { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; pointer-events: none; }
    .custom-toast { background: #111; color: #fff; padding: 12px 24px; border-radius: 50px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); opacity: 0; transition: 0.3s; transform: translateY(-20px); }
    .custom-toast.show { opacity: 1; transform: translateY(0); }
    .custom-toast.error { background: #dc3545; }

    /* --- PRINT STYLES --- */
    #printable-area { display: none; }
    @media print {
      @page { size: A4; margin: 0.6cm; }
      body, html { height: 100%; width: 100%; margin: 0; background-color: white; }
      .main-container, .nav, .btn, #toast-overlay, #installContainer, .modal { display: none !important; }
      
      #printable-area { display: block !important; position: absolute; top: 0; left: 0; width: 100%; font-family: 'Inter', sans-serif; font-size: 11px; color: #000; }
      
      .print-header-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 15px; }
      
      .header-left { width: 30%; text-align: left; }
      .doc-type-main { font-family: 'Playfair Display', serif; font-size: 1.6rem; font-weight: 700; text-transform: uppercase; margin-bottom: 10px; display: block; letter-spacing: 1px; }
      .meta-label { font-size: 0.7rem; color: #666; font-weight: 600; text-transform: uppercase; }
      .meta-val { font-weight: 700; font-size: 1rem; display: block; margin-bottom: 6px; }

      .header-center { width: 40%; text-align: center; display: flex; flex-direction: column; align-items: center; }
      .print-logo { width: 110px; height: auto; margin-bottom: 8px; }
      .company-name { font-family: 'Playfair Display', serif; font-weight: 700; font-size: 1.2rem; text-transform: uppercase; letter-spacing: 1px; line-height: 1.1; }

      .header-right { width: 30%; text-align: right; font-size: 0.85rem; line-height: 1.4; }
      .contact-name { font-weight: 700; display: block; margin-top: 4px; }
      .insta-box { margin-top: 6px; display: inline-flex; align-items: center; gap: 4px; font-weight: 500; }

      .print-customer { margin-bottom: 20px; background: #f9f9f9; padding: 10px; border-radius: 4px; -webkit-print-color-adjust: exact; }
      
      .event-section { margin-bottom: 15px; page-break-inside: avoid; }
      .print-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 0.9rem; }
      .print-table th { text-align: left; border-bottom: 1px solid #000; padding: 5px; font-weight: 700; background: #eee; -webkit-print-color-adjust: exact; }
      .print-table td { padding: 5px; border-bottom: 1px solid #eee; }
      
      .footer-grid { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 20px; page-break-inside: avoid; }
      
      .qr-section { text-align: center; border: 1px solid #ddd; padding: 8px; border-radius: 8px; width: 120px; }
      .qr-img { width: 100px; height: 100px; object-fit: contain; }
      .qr-text { font-size: 0.7rem; font-weight: 700; margin-top: 5px; text-transform: uppercase; }

      .totals-section { width: 250px; text-align: right; font-size: 1rem; }
      .totals-table { width: 100%; }
      .totals-table td { padding: 3px 0; }
      .grand-row { border-top: 2px solid #000; font-weight: 700; font-size: 1.1rem; padding-top: 6px; margin-top: 4px; }

      .terms { margin-top: 30px; border-top: 1px solid #ccc; padding-top: 10px; }
      .terms h6 { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
      .terms ul { margin: 0; padding-left: 15px; font-size: 0.75rem; color: #444; text-align: justify; line-height: 1.4; }
      .terms li { margin-bottom: 3px; }

      .print-footer { margin-top: 20px; text-align: center; font-size: 0.8rem; font-weight: 600; color: #333; }
    }
  </style>
</head>
<body>

  <div id="toast-overlay"><div id="toast-msg" class="custom-toast">Notification</div></div>

  <div class="main-container">
    <div class="text-center mb-5">
      <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" alt="Logo" style="height: 100px; margin-bottom: 15px;">
      <h2 class="brand-font">Pranima Event Management</h2>
      <p class="text-muted">Invoice & Estimate Generator</p>
      <div id="installContainer" class="mt-2"><button id="installBtn" class="btn btn-sm btn-outline-dark rounded-pill"><i class="bi bi-download me-1"></i> Install App</button></div>
    </div>

    <ul class="nav nav-pills nav-fill mb-4 gap-2">
      <li class="nav-item"><button class="nav-link active" id="tab-gen-btn" data-bs-toggle="tab" data-bs-target="#tab-generator">New Invoice</button></li>
      <li class="nav-item"><button class="nav-link" id="tab-hist-btn" data-bs-toggle="tab" data-bs-target="#tab-history" onclick="fetchHistory()">History</button></li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-generator">
        <form id="mainForm" onsubmit="event.preventDefault(); saveRecord();">
          
          <div id="editModeIndicator" class="d-none alert alert-warning d-flex justify-content-between align-items-center mb-3">
             <span><strong>Editing:</strong> <span id="editIdDisplay"></span></span>
             <button type="button" class="btn btn-sm btn-outline-dark" onclick="cancelEditMode()">Cancel Edit</button>
          </div>

          <div class="row g-4 mb-4">
            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold">Customer</label>
              <input type="text" class="form-control mb-2" id="custName" placeholder="Full Name" required>
              <input type="tel" class="form-control" id="custPhone" placeholder="Mobile Number" required>
            </div>
            <div class="col-md-6">
              <label class="form-label text-muted small fw-bold">Document</label>
              <div class="d-flex gap-2 mb-2">
                <select class="form-select" id="docType"><option value="Estimate">Estimate</option><option value="Invoice">Invoice</option></select>
                <input type="date" class="form-control" id="docDate" required>
              </div>
            </div>
          </div>

          <div id="events-container"></div>
          
          <button type="button" class="btn btn-outline-dark w-100 py-3 mb-4" style="border-style: dashed;" onclick="addEventBlock()">
             <i class="bi bi-plus-circle me-1"></i> Add Another Event
          </button>

          <div class="payment-summary mb-4">
             <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Total Amount</span>
                <span class="fw-bold fs-5">₹<span id="displayTotal">0.00</span></span>
             </div>
             <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="text-muted">Advance Payment</span>
                <input type="number" id="advanceAmt" class="form-control text-end" style="width: 140px;" placeholder="0" oninput="calculateTotal()">
             </div>
             <div class="d-flex justify-content-between pt-3 border-top">
                <span class="fw-bold">Remaining Balance</span>
                <span class="fw-bold fs-4 text-danger">₹<span id="displayRemaining">0.00</span></span>
             </div>
          </div>

          <div class="d-flex justify-content-end gap-3">
             <button type="button" class="btn btn-lg btn-secondary" onclick="generatePreview()">Print Preview</button>
             <button type="submit" class="btn btn-lg btn-dark px-5"><span id="saveBtnText">Save & Print</span><span id="saveSpinner" class="spinner-border spinner-border-sm ms-2 d-none"></span></button>
          </div>
        </form>
      </div>

      <div class="tab-pane fade" id="tab-history">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <input type="text" id="searchInput" class="form-control w-75" placeholder="Search..." onkeyup="filterHistory()">
          <button class="btn btn-outline-secondary" onclick="fetchHistory()"><i class="bi bi-arrow-clockwise"></i></button>
        </div>
        <div id="historyList">
           <div class="text-center py-5 text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content border-0 shadow-lg rounded-4">
        <div class="modal-header border-0 pb-0">
          <h5 class="modal-title fw-bold">Update Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body pt-4">
          <label class="form-label text-muted small fw-bold text-uppercase">Total Advance Received</label>
          <div class="input-group input-group-lg">
            <span class="input-group-text bg-light border-end-0 text-muted">₹</span>
            <input type="number" id="modalAdvanceInput" class="form-control border-start-0 bg-light" placeholder="0.00">
          </div>
          <div class="form-text mt-2">Enter the new <strong>TOTAL</strong> amount paid by the customer.</div>
        </div>
        <div class="modal-footer border-0 pt-0 pb-4">
          <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-dark rounded-pill px-4" onclick="submitPaymentUpdate()">Update Total</button>
        </div>
      </div>
    </div>
  </div>

  <div id="printable-area"></div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ==========================================
    // PASTE YOUR WEB APP URL HERE
    // ==========================================
    const API_URL = "https://script.google.com/macros/s/AKfycbzimQLhnbiV0IDut5yz6s9xlDY_jBl0X0e-yYQTAZE4LDpreE9y1ywLqOuCdKO-IXB9/exec"; 
    // ==========================================

    let historyCache = [];
    let currentUpdateId = null; 
    let editingId = null; // Tracks if we are editing an old record
    
    const payModal = new bootstrap.Modal(document.getElementById('paymentModal'));

    document.getElementById('docDate').valueAsDate = new Date();
    addEventBlock();

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('./service-worker.js').catch(console.error)); }
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; document.getElementById('installBtn').style.display = 'inline-block'; });
    document.getElementById('installBtn').addEventListener('click', () => { document.getElementById('installBtn').style.display = 'none'; if(deferredPrompt) deferredPrompt.prompt(); });

    async function callApi(payload) {
      const formBody = new URLSearchParams();
      formBody.append("payload", JSON.stringify(payload));
      const response = await fetch(API_URL, { method: "POST", body: formBody, headers: { "Content-Type": "application/x-www-form-urlencoded" } });
      return await response.json();
    }

    // Calculations
    function calculateTotal() {
      let total = 0;
      document.querySelectorAll('.equipment-row').forEach(row => {
         const qty = parseFloat(row.querySelector('.qty-input').value) || 1;
         const price = parseFloat(row.querySelector('.price-input').value) || 0;
         total += (qty * price);
      });
      const adv = parseFloat(document.getElementById('advanceAmt').value) || 0;
      const rem = total - adv;
      document.getElementById('displayTotal').innerText = total.toLocaleString('en-IN', {minimumFractionDigits:2});
      document.getElementById('displayRemaining').innerText = rem.toLocaleString('en-IN', {minimumFractionDigits:2});
      return { total, adv, rem };
    }

    // Builder Functions
    function addEventBlock(data = null) {
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      div.className = 'event-block';
      div.id = `evt-${id}`;
      div.innerHTML = `
        <button type="button" class="delete-event-btn" onclick="removeEl('evt-${id}')"><i class="bi bi-trash"></i></button>
        <div class="row g-3 mb-3">
           <div class="col-md-8"><label class="form-label text-muted small">Event Name</label><input type="text" class="form-control fw-bold event-name" placeholder="e.g. Wedding" required value="${data ? data.eventName : ''}"></div>
           <div class="col-md-4"><label class="form-label text-muted small">Date</label><input type="date" class="form-control event-date" required value="${data ? data.eventDate : ''}"></div>
        </div>
        <div class="items-list"></div>
        <button type="button" class="btn btn-sm btn-link text-decoration-none p-0 mt-3" onclick="addItemRow(this)">+ Add Item/Service</button>
      `;
      document.getElementById('events-container').appendChild(div);
      
      const list = div.querySelector('.items-list');
      if (data && data.items) {
         data.items.forEach(item => addItemRowToContainer(list, item));
      } else {
         addItemRowToContainer(list); // Add one empty row
      }
    }

    function addItemRow(btn) {
      addItemRowToContainer(btn.previousElementSibling);
    }

    function addItemRowToContainer(container, itemData = null) {
      const id = Date.now() + Math.random();
      const div = document.createElement('div');
      div.className = 'equipment-row';
      div.id = `item-${id}`;
      div.innerHTML = `
        <div style="flex: 2"><input type="text" class="form-control item-name" placeholder="Item Name" required value="${itemData ? itemData.name : ''}"></div>
        <div style="width: 80px"><input type="number" class="form-control qty-input text-center" value="${itemData ? itemData.qty : '1'}" placeholder="Qty" oninput="calculateTotal()"></div>
        <div style="width: 120px"><input type="number" class="form-control price-input text-end" placeholder="Price" oninput="calculateTotal()" value="${itemData ? itemData.price : ''}"></div>
        <button type="button" class="btn-remove-item" onclick="removeEl('item-${id}')"><i class="bi bi-x-lg"></i></button>
      `;
      container.appendChild(div);
    }

    function removeEl(id) { document.getElementById(id).remove(); calculateTotal(); }

    function getFormData() {
      const nums = calculateTotal();
      const data = {
        customerName: document.getElementById('custName').value,
        customerPhone: document.getElementById('custPhone').value,
        type: document.getElementById('docType').value,
        issueDate: document.getElementById('docDate').value,
        grandTotal: nums.total.toLocaleString('en-IN', {minimumFractionDigits:2}),
        advance: nums.adv,
        remaining: nums.rem,
        events: []
      };
      document.querySelectorAll('.event-block').forEach(blk => {
        const evt = { eventName: blk.querySelector('.event-name').value, eventDate: blk.querySelector('.event-date').value, items: [] };
        blk.querySelectorAll('.equipment-row').forEach(row => {
            evt.items.push({ 
                name: row.querySelector('.item-name').value, 
                qty: row.querySelector('.qty-input').value, 
                price: row.querySelector('.price-input').value 
            });
        });
        data.events.push(evt);
      });
      return data;
    }

    // --- SAVE / EDIT LOGIC ---
    async function saveRecord() {
      const form = document.getElementById('mainForm');
      if (!form.checkValidity()) { form.reportValidity(); return; }
      
      const btn = document.getElementById('saveBtnText');
      const spinner = document.getElementById('saveSpinner');
      
      btn.innerText = editingId ? "Updating..." : "Saving..."; 
      spinner.classList.remove('d-none');
      
      try {
        const data = getFormData();
        let res;
        
        if (editingId) {
           // EDIT MODE
           data.invoiceId = editingId; // Keep same ID
           res = await callApi({ action: 'UPDATE_FULL_RECORD', data: data });
        } else {
           // NEW MODE
           res = await callApi({ action: 'SAVE', data: data });
        }

        btn.innerText = "Save & Print"; 
        spinner.classList.add('d-none');
        
        if (res.success) { 
            showToast(editingId ? "Record Updated" : "Saved Successfully"); 
            // If editing, keep ID; if new, use generated ID
            data.invoiceId = editingId ? editingId : res.id; 
            printInvoice(data);
            
            if(editingId) cancelEditMode(); // Reset form after edit
        }
        else { showToast("Error: " + res.error, "error"); }
      } catch (err) { 
        btn.innerText = "Save & Print"; 
        spinner.classList.add('d-none'); 
        showToast("Connection Error", "error"); 
      }
    }

    // --- HISTORY LOGIC ---
    async function fetchHistory() {
      const list = document.getElementById('historyList');
      list.innerHTML = '<div class="text-center py-5 text-muted">Loading...</div>';
      try {
        const data = await callApi({ action: 'GET_HISTORY' });
        historyCache = data;
        renderHistory(data);
      } catch (err) { list.innerHTML = `<div class="text-center text-danger">Failed to load</div>`; }
    }

    function renderHistory(data) {
       const list = document.getElementById('historyList');
       list.innerHTML = '';
       if (!data || data.length === 0) { list.innerHTML = '<div class="text-center text-muted">No records found.</div>'; return; }
       
       data.forEach(row => {
          let rec = { advance: row.advance || 0, remaining: row.remaining || row.total, grandTotal: row.total };
          try { if(row.jsonData) rec = JSON.parse(row.jsonData); } catch(e){}
          if(row.advance !== undefined) { rec.advance = row.advance; rec.remaining = row.remaining; }

          const div = document.createElement('div');
          div.className = 'history-card';
          div.innerHTML = `
            <div class="d-flex justify-content-between mb-2">
               <span class="text-muted small">${new Date(row.date).toLocaleDateString('en-IN')}</span>
               <span class="fw-bold">${row.id}</span>
            </div>
            <h5 class="mb-2">${row.name}</h5>
            <div class="d-flex gap-2 mb-3">
               <span class="badge-paid">Paid: ₹${rec.advance}</span>
               <span class="badge-due">Bal: ₹${rec.remaining}</span>
            </div>
            <div class="d-flex justify-content-between align-items-center pt-2 border-top">
               <span class="fw-bold">₹${rec.grandTotal}</span>
               <div class="d-flex gap-2">
                  <button class="btn btn-sm btn-outline-dark" onclick='startEditMode("${row.id}")' title="Edit Bill"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-dark" onclick='openPayModal("${row.id}", ${rec.advance})' title="Update Payment">Pay</button>
                  <button class="btn btn-sm btn-outline-dark" onclick='reprintHistory("${row.id}")' title="Print"><i class="bi bi-printer"></i></button>
                  <button class="btn btn-sm btn-outline-danger" onclick='deleteHistory("${row.id}")'><i class="bi bi-trash"></i></button>
               </div>
            </div>
          `;
          list.appendChild(div);
       });
    }

    // --- EDIT MODE LOGIC ---
    function startEditMode(id) {
       const record = historyCache.find(r => r.id === id);
       if(!record || !record.jsonData) return;
       
       const data = JSON.parse(record.jsonData);
       
       // Populate Fields
       document.getElementById('custName').value = data.customerName;
       document.getElementById('custPhone').value = data.customerPhone;
       document.getElementById('docType').value = data.type;
       document.getElementById('docDate').value = data.issueDate;
       document.getElementById('advanceAmt').value = data.advance;
       
       // Clear and Populate Events
       const container = document.getElementById('events-container');
       container.innerHTML = '';
       data.events.forEach(evt => addEventBlock(evt));
       
       calculateTotal();
       
       // Set Edit State
       editingId = id;
       document.getElementById('editModeIndicator').classList.remove('d-none');
       document.getElementById('editIdDisplay').innerText = id;
       document.getElementById('saveBtnText').innerText = "Update Record";
       
       // Switch to Form Tab
       const triggerEl = document.querySelector('#tab-gen-btn');
       const tab = new bootstrap.Tab(triggerEl);
       tab.show();
       
       window.scrollTo(0, 0);
    }

    function cancelEditMode() {
       editingId = null;
       document.getElementById('mainForm').reset();
       document.getElementById('events-container').innerHTML = '';
       addEventBlock(); // Add one empty
       document.getElementById('docDate').valueAsDate = new Date();
       calculateTotal();
       
       document.getElementById('editModeIndicator').classList.add('d-none');
       document.getElementById('saveBtnText').innerText = "Save & Print";
    }

    // --- PAYMENT MODAL ---
    function openPayModal(id, currentAdvance) {
       currentUpdateId = id;
       document.getElementById('modalAdvanceInput').value = currentAdvance;
       payModal.show();
    }

    async function submitPaymentUpdate() {
       const newTotalAdvance = document.getElementById('modalAdvanceInput').value;
       if(!newTotalAdvance || currentUpdateId === null) return;
       payModal.hide();
       showToast("Updating Payment...");
       try {
         const res = await callApi({ action: 'UPDATE_PAYMENT', id: currentUpdateId, newTotalAdvance: newTotalAdvance });
         if(res.success) { showToast("Payment Updated!"); fetchHistory(); } else { showToast("Error", "error"); }
       } catch(e) { showToast("Failed", "error"); }
    }

    async function deleteHistory(id) {
       if(!confirm("Delete " + id + "?")) return;
       showToast("Deleting...");
       try { const res = await callApi({ action: 'DELETE', id: id }); if(res.success){ showToast("Deleted"); fetchHistory();} } catch(e){}
    }
    
    function reprintHistory(id) { const record = historyCache.find(r => r.id === id); if (record) { const data = JSON.parse(record.jsonData); data.invoiceId = id; printInvoice(data); } }
    function filterHistory() { const term = document.getElementById('searchInput').value.toLowerCase(); const cards = document.querySelectorAll('.history-card'); cards.forEach(c => c.style.display = c.innerText.toLowerCase().includes(term) ? '' : 'none'); }
    function showToast(msg, type) { const t=document.getElementById('toast-msg'); t.innerText=msg; t.className=`custom-toast show ${type}`; setTimeout(()=>t.classList.remove('show'),3000); }
    function generatePreview() { const data = getFormData(); data.invoiceId = "PREVIEW"; printInvoice(data); }

    function printInvoice(data) {
      try {
        const area = document.getElementById('printable-area');
        const totalStr = String(data.grandTotal).replace(/,/g,'');
        const total = parseFloat(totalStr);
        const adv = parseFloat(data.advance) || 0;
        const rem = parseFloat(data.remaining) || (total - adv);

        let html = `
          <div class="print-header-grid">
             <div class="header-left">
                <span class="doc-type-main">${data.type}</span>
                <span class="meta-label">ID:</span>
                <span class="meta-val">${data.invoiceId}</span>
                <span class="meta-label">DATE:</span>
                <span class="meta-val">${new Date(data.issueDate).toLocaleDateString('en-IN')}</span>
             </div>

             <div class="header-center">
                <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765783044/IMG-20251214-WA0000_2_a7xig7.jpg" class="print-logo" loading="eager">
                <div class="company-name">Pranima Event Management</div>
             </div>

             <div class="header-right">
                <div class="contact-name">Roshan Mate</div>
                <div>+91 96371 07112</div>
                <div>+91 85519 35834</div>
                <div class="insta-box">
                   <i class="bi bi-instagram"></i> @pranimaevents
                </div>
             </div>
          </div>

          <div class="print-customer">
             <strong>Bill To:</strong><br>
             <span style="font-size:1.1em">${data.customerName}</span><br>
             ${data.customerPhone}
          </div>
        `;

        data.events.forEach(evt => {
          html += `
            <div class="event-section">
               <strong>${evt.eventName}</strong> <span style="color:#555; font-size:0.9em; margin-left:5px">(${new Date(evt.eventDate).toLocaleDateString('en-IN')})</span>
               <table class="print-table">
                 <thead><tr><th width="50%">Item Description</th><th width="15%" class="text-center">Qty</th><th width="20%" class="text-end">Rate</th><th width="15%" class="text-end">Amount</th></tr></thead>
                 <tbody>
          `;
          evt.items.forEach(item => {
             const qty = parseFloat(item.qty);
             const rate = parseFloat(item.price);
             const amt = qty * rate;
             html += `<tr><td>${item.name}</td><td class="text-center">${qty}</td><td class="text-end">${rate}</td><td class="text-end">${amt.toLocaleString('en-IN')}</td></tr>`;
          });
          html += `</tbody></table></div>`;
        });

        html += `
          <div class="footer-grid">
              <div class="qr-section">
                 <img src="https://res.cloudinary.com/dowhvdkjh/image/upload/v1765809556/IMG-20251215-WA0003_3_byhvkw.jpg" class="qr-img" loading="eager">
                 <div class="qr-text">Scan to Pay</div>
              </div>
              <div class="totals-section">
                 <table class="totals-table">
                    <tr><td>Total Amount:</td><td>₹${total.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
                    <tr><td>Advance Paid:</td><td>₹${adv.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
                    <tr><td class="grand-row">Balance Due:</td><td class="grand-row">₹${rem.toLocaleString('en-IN', {minimumFractionDigits:2})}</td></tr>
                 </table>
              </div>
          </div>

          <div class="terms">
             <h6>Terms & Conditions</h6>
             <ul>
                <li><strong>Payment Schedule:</strong> 70% advance payment is required to confirm the booking. The remaining 30% must be paid on the day of the event.</li>
                <li><strong>Technical & Weather Liability:</strong> We are not liable for any service interruptions or issues caused by technical failures, power outages, or adverse weather conditions beyond our control.</li>
                <li><strong>Injury Disclaimer:</strong> We are not responsible for any injuries sustained by individuals due to improper interaction with our equipment.</li>
                <li><strong>Cancellation Policy:</strong> Advance payments are strictly non-refundable in the event of cancellation by the customer.</li>
                <li><strong>Equipment On-Site:</strong> Once equipment or items have reached the event venue, their cost is non-refundable, even if the order is subsequently cancelled.</li>
             </ul>
          </div>
          <div class="print-footer">Thank you for choosing Pranima Event Management!</div>
        `;
        area.innerHTML = html;
        setTimeout(() => window.print(), 1000); // 1 Second Delay for Images
      } catch(e) {
        alert("Print Error: " + e.message);
      }
    }
  </script>
</body>
</html>
